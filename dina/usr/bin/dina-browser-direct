#! /bin/bash
## /usr/bin/dina-browser-direct

# This is a helper script to start Dina web browser. Dina is a minimal browser built with tauri and Pake. It uses the webkit rendering engine. 
# This script launches a local server using flask and opens Dina in localhost to redirect to the url user-chosen url. If no url is chosen, Dina opens last chosen url or the default url at first launch. After launch the server instance is terminated.
# Dina (https://github.com/iontelos/Dina) is maintained by Ion@TeLOS (teloslinux@protonmail.com). 
# Pake is a credited external project. Learn more about Pake at https://github.com/tw93/Pake

ARGUMENT=$1

DEFAULTENGINE=$HOME/.config/dina/searchengine.txt
if test -f "$DEFAULTENGINE"
then
SEARCHENGINE=$(head -n 1 $HOME/.config/dina/searchengine.txt)
else
SEARCHENGINE="https://www.google.com/search?q="
fi

go-fullscreen()
{
STARTPAGE=$HOME/.config/dina/startpage.txt
if test -f "$STARTPAGE"
then
truncate -s 0 /usr/bin/templates/index.html
STARTURL=$(head -n 1 $HOME/.config/dina/startpage.txt)
echo -e '<!DOCTYPE html>\n<html> \n<head>\n<title>Google</title>\n<meta charset="UTF-8" /> \n<meta http-equiv="refresh" content="0; URL='$STARTURL'">\n</head>\n<body>\n<p><b>Loading..</b></p>\n</body>\n</html>' >> /usr/bin/templates/index.html
echo "loading user-set startpage.."
python3 /usr/bin/dina-run-flask.py &
sleep 1 &&
/usr/bin/dina &
sleep 5 &&
/usr/bin/dina-title.sh
ps -ef | grep "dina-run-flask" | awk '{print $2}' | xargs kill &
wmctrl -r ':ACTIVE:' -b toggle,fullscreen
exit
else
echo "loading last user's choice.."
python3 /usr/bin/dina-run-flask.py &
sleep 1 &&
/usr/bin/dina &
sleep 5 &&
/usr/bin/dina-title.sh
ps -ef | grep "dina-run-flask" | awk '{print $2}' | xargs kill &
wmctrl -r ':ACTIVE:' -b toggle,fullscreen
exit
fi
}

write-desktop()
{
du -a -h $HOME/.config/dina/webappicons/"$NAME"/*.png

if [ $? -eq 1 ]
then
ICON=dina-browser
echo "no suitable icon found, using default Dina icon.."
else
TICON=$(du -a -h $HOME/.config/dina/webappicons/"$NAME"/*.png | sort -n -r | head -n 1)
ICON="${TICON#*K}"
echo "icon is: $ICON"
fi

echo "
[Desktop Entry]
Version=1.0
Type=Application
Comment="$NAME" webapp powered by Dina
Icon=$ICON
Exec=/usr/bin/dina-browser-direct $ADDRESS & sleep 7 && xdotool search --onlyvisible --class "$ADDRESS" set_window --name "$NAME"
Name="$NAME"
Categories=WebApps;
StartupWMClass=$ADDRESS" | sudo -u $USER tee -a "$HOME/.local/share/applications/$NAME.desktop"
echo "webapp is ready"
notify-send -a Dina -i dina-browser "Your new webapp is ready, enjoy!" "You can launch it from the menu" &
}

if [[ "$ARGUMENT" == "--fullscreen" ]] || [[ "$ARGUMENT" == "fullscreen" ]]
then
go-fullscreen &
exit
fi

if [[ "$ARGUMENT" == "--install" ]] || [[ "$ARGUMENT" == "install" ]]
then
FAVAPP=/home/$USER/.local/bin/get-favicon
if test -f "$FAVAPP"; then
    echo "$FAVAPP exists"
else
echo "downloading get-favicon app from GitHub"
notify-send -a Dina -i dina-browser "Please wait.." "downloading additional required component" &
wget https://github.com/IonTeLOS/get-favicon/releases/download/public/get-favicon -O $HOME/.local/bin/get-favicon && 
chmod a+x $HOME/.local/bin/get-favicon
fi
ADDRESS=$2
NAME=$(wget --quiet -O - $ADDRESS | paste -s -d " " | sed -e 's!.*<head>\(.*\)</head>.*!\1!' | sed -e 's!.*<title>\(.*\)</title>.*!\1!') &&
mkdir -p $HOME/.config/dina/webappicons/"$NAME" &&     
$HOME/.local/bin/get-favicon $ADDRESS "$NAME" $HOME/.config/dina/webappicons/"$NAME" &&
write-desktop &&
exit
fi

STARTPAGE=$HOME/.config/dina/startpage.txt
if test -f "$STARTPAGE"
then
truncate -s 0 /usr/bin/templates/index.html
STARTURL=$(head -n 1 $HOME/.config/dina/startpage.txt)
echo -e '<!DOCTYPE html>\n<html> \n<head>\n<title>Google</title>\n<meta charset="UTF-8" /> \n<meta http-equiv="refresh" content="0; URL='$STARTURL'">\n</head>\n<body>\n<p><b>Loading..</b></p>\n</body>\n</html>' > /usr/bin/templates/index.html
echo "loading user-set startpage.."
fi

if [[ "$ARGUMENT" != "" ]]
then
truncate -s 0 /usr/bin/templates/index.html
else
python3 /usr/bin/dina-run-flask.py &
sleep 1 &&
/usr/bin/dina &
sleep 5 &&
/usr/bin/dina-title.sh
ps -ef | grep "dina-run-flask" | awk '{print $2}' | xargs kill &
exit
fi

if [[ "$ARGUMENT" != http* ]]
then
echo -e '<!DOCTYPE html>\n<html> \n<head>\n<title>Google</title>\n<meta charset="UTF-8" /> \n<meta http-equiv="refresh" content="0; URL='https://''$ARGUMENT'">\n</head>\n<body>\n<p><b>Loading..</b></p>\n</body>\n</html>' > /usr/bin/templates/index.html
python3 /usr/bin/dina-run-flask.py &
sleep 1 &&
/usr/bin/dina &
sleep 5 &&
/usr/bin/dina-title.sh
ps -ef | grep "dina-run-flask" | awk '{print $2}' | xargs kill &
else
echo -e '<!DOCTYPE html>\n<html> \n<head>\n<title>Google</title>\n<meta charset="UTF-8" /> \n<meta http-equiv="refresh" content="0; URL='$ARGUMENT'">\n</head>\n<body>\n<p><b>Loading..</b></p>\n</body>\n</html>' > /usr/bin/templates/index.html
python3 /usr/bin/dina-run-flask.py &
sleep 1 &&
/usr/bin/dina &
sleep 5 &&
/usr/bin/dina-title.sh
ps -ef | grep "dina-run-flask" | awk '{print $2}' | xargs kill &
fi

if [[ $2 == "fullscreen" ]] || [[ $2 == "--fullscreen" ]]
then
echo "going fullscreen.."
wmctrl -r ':ACTIVE:' -b toggle,fullscreen
exit
else
exit
fi
